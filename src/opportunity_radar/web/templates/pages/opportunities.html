{% extends "base.html" %}

{% block title %}All Opportunities - OpportunityBug{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header with filters -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">All Opportunities</h1>
            <p class="text-sm text-gray-500 mt-1">{{ opportunities|length }} opportunities</p>
        </div>

        <!-- Sort Controls -->
        <div class="flex items-center space-x-3">
            <label class="text-sm text-gray-600">Sort by:</label>
            <select id="sort-select" onchange="updateSort()"
                    class="block w-40 rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 text-sm">
                <option value="ai_score" {% if current_sort == 'ai_score' %}selected{% endif %}>AI Score</option>
                <option value="user_rating" {% if current_sort == 'user_rating' %}selected{% endif %}>My Rating</option>
                <option value="date" {% if current_sort == 'date' %}selected{% endif %}>Date Added</option>
                <option value="deadline" {% if current_sort == 'deadline' %}selected{% endif %}>Deadline</option>
            </select>
            <button onclick="toggleOrder()" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Toggle order">
                <svg id="order-icon" class="w-5 h-5 text-gray-600 {% if current_order == 'asc' %}rotate-180{% endif %} transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Desktop Table View -->
    <div class="hidden sm:block bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Opportunity</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">AI Score</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">My Rating</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deadline</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for opp in opportunities %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-4">
                        <div class="flex items-start">
                            <div class="min-w-0 flex-1">
                                <a href="{{ opp.url }}" target="_blank" rel="noopener"
                                   class="text-sm font-medium text-gray-900 hover:text-primary-600 truncate block max-w-xs">
                                    {{ opp.title }}
                                </a>
                                <p class="text-sm text-gray-500 truncate max-w-xs">{{ opp.organization }}</p>
                                {% if opp.location %}
                                <p class="text-xs text-gray-400 mt-1 flex items-center gap-1">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    {{ opp.location }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if opp.type == 'fellowship' %}type-badge-fellowship
                            {% elif opp.type == 'internship' %}type-badge-internship
                            {% elif opp.type == 'hackathon' %}type-badge-hackathon
                            {% elif opp.type == 'job' %}type-badge-job
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ opp.type or 'Unknown' }}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        {% if opp.relevance_score is not none %}
                        <div class="flex items-center">
                            <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden mr-2">
                                <div class="h-full rounded-full
                                    {% if opp.relevance_score >= 0.7 %}bg-green-500
                                    {% elif opp.relevance_score >= 0.4 %}bg-yellow-500
                                    {% else %}bg-red-500{% endif %}"
                                    style="width: {{ (opp.relevance_score * 100)|int }}%"></div>
                            </div>
                            <span class="text-sm font-medium
                                {% if opp.relevance_score >= 0.7 %}score-high
                                {% elif opp.relevance_score >= 0.4 %}score-medium
                                {% else %}score-low{% endif %}">{{ "%.0f"|format(opp.relevance_score * 100) }}%</span>
                        </div>
                        {% else %}
                        <span class="text-sm text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        {% if opp.user_rating %}
                        <div class="flex items-center">
                            {% for i in range(5) %}
                            <svg class="w-4 h-4 {% if i < opp.user_rating %}text-yellow-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="text-sm text-gray-400">Not rated</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        {% if opp.deadline %}
                        <span class="text-sm deadline-urgent">{{ opp.deadline }}</span>
                        {% else %}
                        <span class="text-sm text-gray-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <a href="{{ opp.url }}" target="_blank" rel="noopener"
                           class="text-primary-600 hover:text-primary-700 text-sm font-medium">
                            View
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-4 py-12 text-center">
                        <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                            <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900">No opportunities found</h3>
                        <p class="text-gray-500 mt-1">Check back later for new opportunities.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Card View -->
    <div class="sm:hidden space-y-3">
        {% for opp in opportunities %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full
                            {% if opp.type == 'fellowship' %}type-badge-fellowship
                            {% elif opp.type == 'internship' %}type-badge-internship
                            {% elif opp.type == 'hackathon' %}type-badge-hackathon
                            {% elif opp.type == 'job' %}type-badge-job
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ opp.type or 'Unknown' }}
                        </span>
                        {% if opp.relevance_score %}
                        <span class="text-xs font-medium
                            {% if opp.relevance_score >= 0.7 %}score-high
                            {% elif opp.relevance_score >= 0.4 %}score-medium
                            {% else %}score-low{% endif %}">
                            {{ "%.0f"|format(opp.relevance_score * 100) }}%
                        </span>
                        {% endif %}
                    </div>
                    <a href="{{ opp.url }}" target="_blank" rel="noopener" class="font-medium text-gray-900 hover:text-primary-600 block">
                        {{ opp.title }}
                    </a>
                    <p class="text-sm text-gray-500 mt-1">{{ opp.organization }}</p>
                </div>
                {% if opp.user_rating %}
                <div class="shrink-0 flex">
                    {% for i in range(opp.user_rating) %}
                    <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                    </svg>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-100">
                {% if opp.deadline %}
                <span class="text-xs deadline-urgent">{{ opp.deadline }}</span>
                {% else %}
                <span class="text-xs text-gray-400">No deadline</span>
                {% endif %}
                <a href="{{ opp.url }}" target="_blank" rel="noopener"
                   class="text-sm font-medium text-primary-600 hover:text-primary-700">
                    View &rarr;
                </a>
            </div>
        </div>
        {% else %}
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 text-center">
            <div class="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
            </div>
            <h3 class="text-lg font-medium text-gray-900">No opportunities found</h3>
            <p class="text-gray-500 mt-1">Check back later for new opportunities.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentOrder = '{{ current_order }}';

    function updateSort() {
        const sort = document.getElementById('sort-select').value;
        window.location.href = `/opportunities?sort=${sort}&order=${currentOrder}`;
    }

    function toggleOrder() {
        currentOrder = currentOrder === 'desc' ? 'asc' : 'desc';
        const sort = document.getElementById('sort-select').value;
        window.location.href = `/opportunities?sort=${sort}&order=${currentOrder}`;
    }
</script>
{% endblock %}
